#!/bin/bash

# This script acts as a basic su wrapper using run0.
# It handles the common case of switching to root to run a command.

RUN0_EXEC="run0"
RUN0_BACKGROUND="--background="

# --- Function to display usage information ---

show_help() {
    cat << 'EOF'
run0-su - run a command with substitute user and group ID via run0

Usage: run0-su [options] [-] [user [argument...]]

Options:
  -c, --command <command>  Pass command to the shell with the -c option
  -f, --fast               Pass -f to the shell
  -g, --group <group>      Run with <group> as primary group
  -l, --login, -           Start the shell as a login shell
  -P, --pty                Create a pseudo-terminal for the session
  -s, --shell <shell>      Run the specified <shell> instead of the default
  -w, --whitelist-environment <list>
                           Donâ€™t reset specified environment variables
  -h, --help               Display help text and exit
  -V, --version            Display version and exit
EOF
}

show_usage() {
    echo "Try 'run0-su --help' for more information."
}

show_version() {
    run0_version="$(run0 --version 2>/dev/null | head -n 1 | cut -d' ' -f3 | sed 's/[()]//g')"
    echo "run0-su (@PACKAGE@) @VERSION@"
    echo "systemd run0 version $run0_version"
}

# --- Get shell for the target user or current user ---
get_shell() {
    local targetuser=$1

    if [ -n "$SHELL" ]; then
        echo "$SHELL"
    else
	# otherwise, get the shell of the target user
	local shell
	shell=$(getent passwd "$targetuser" 2>/dev/null | cut -d: -f7)
	echo "$shell"
    fi
}

# --- Main Logic ---

# Array to hold the final command and arguments for run0
RUN0_ARGS=("$RUN0_BACKGROUND")
RUN0_COMMANDS=()
RUN0_ENV=()

# Variables to track user and command
RUN0_SHELL=""
TARGET_USER=""
TARGET_GROUP=""
LOGIN_SHELL=0

while (( "$#" )); do
    arg="$1"

    case "$arg" in
        -c|--command)
            # The next argument is the command string
            if (( "$#" )); then
		RUN0_COMMANDS+=("-c")
		RUN0_COMMANDS+=("$2")
            else
                echo "run0-su: option requires an argument -- '$arg'" >&2
                show_usage >&2
		exit 1
            fi
	    shift 2
            ;;
	-f|--fast)
	    RUN0_COMMANDS+=("-f")
            shift
            ;;
	-g|--group)
	    TARGET_GROUP="--group=$2"
	    shift 2
	    ;;
	-G|--supp-group)
	    echo "run0-su: group option '$arg' is ignored." >&2
	    shift 2
	    ;;
        -|-l|--login)
	    RUN0_COMMANDS+=("-l")
	    LOGIN_SHELL=1
	    shift
            ;;
        -m|-p|--preserve-environment)
            echo "run0-su: preserve environment option '%arg' is ignored." >&2
            shift
            ;;
	-P |--pty)
	    RUN0_ARGS+=("--pty-late")
            shift
            ;;
	-s|--shell)
	    # The next argument is the shell
	    RUN0_SHELL="$2"
	    shift 2
	    ;;
	--shell=*)
	    RUN0_SHELL="${1#*=}"
            shift
            ;;
	-w|--whitelist-environment)
	    VARS=$(echo "$2" | tr ',' ' ')
	    for var in $VARS; do
		# Remove whitespace
		var="${var//[[:blank:]]/}"
		RUN0_ENV+=("--setenv=$var")
	    done
	    shift 2
	    ;;
	-h|--help)
	    show_help
	    shift
	    exit 0
	    ;;
	-V|--version)
	    show_version
	    shift
	    exit 0
	    ;;
        -*)
	    echo "run0-su: invalid option -- '$arg'" >&2
	    show_usage
	    exit 1
            ;;
        root)
            TARGET_USER="root"
            shift
            ;;
        *)
            # This must be the target user or the start of a command/arguments
            if [ -z "$TARGET_USER" ]; then
                # First positional argument is the user
                TARGET_USER="$arg"
                shift
            else
		echo "run0-su: invalid option -- '$arg'" >&2
		show_usage >&2
		exit 1
            fi
            ;;
    esac
done

RUN0_COMMANDS+=("$@")

# we need a shell for -l and change CWD to ~
if [ $LOGIN_SHELL -eq 1 ]; then
    if [ -z "$TARGET_USER" ]; then
	# run0 will change home if target user is specified
	TARGET_USER="root"
    fi
else
    # No login shell, keep current directory
    RUN0_ARGS+=("--chdir=$PWD")
fi

if [ -z "$RUN0_SHELL" ]; then
    RUN0_SHELL=$(get_shell "$TARGET_USER")
fi

if [ -n "$TARGET_USER" ]; then
    RUN0_ARGS+=("--user=${TARGET_USER}")
fi
if [ -n "$TARGET_GROUP" ]; then
    RUN0_ARGS+=("--group=${TARGET_GROUP}")
fi

if [ ${LOGIN_SHELL} -eq 0 ]; then
    mapfile -t RUN0_ENV < <(printenv | grep -v ^_ | grep -v ^PATH= | awk '{print "--setenv="$0}')
fi

exec "${RUN0_EXEC}" "${RUN0_ARGS[@]}" "${RUN0_ENV[@]}" -- ${RUN0_SHELL} "${RUN0_COMMANDS[@]}"
